---
import Gallery from './Gallery.astro';
import type { ImageMetadata } from 'astro';

interface Props {
	postSlug: string;
	galleryName?: string;
	columns?: number;
	title?: string;
	showCaptions?: boolean;
}

const { postSlug, galleryName = 'gallery', columns = 3, title, showCaptions = false } = Astro.props;

const allGalleryImages = import.meta.glob<{ default: ImageMetadata }>(
	'/src/assets/images/posts/**/gallery*/*.{jpg,jpeg,png,gif,webp}',
	{ eager: true }
);

const matched = Object.entries(allGalleryImages)
	.filter(([path]) => {
		const segments = path.split('/');
		const postsIdx = segments.indexOf('posts');
		if (postsIdx === -1) return false;
		const slug = segments[postsIdx + 1];
		const gallery = segments[postsIdx + 2];
		return slug === postSlug && gallery === galleryName;
	})
	.sort(([a], [b]) => a.localeCompare(b));

const images: ImageMetadata[] = matched.map(([, mod]) => mod.default);
const alts = matched.map(([path]) => {
	const filename = path.split('/').pop()?.replace(/\.[^.]+$/, '') || '';
	return filename.replace(/[_-]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
});
const captions = showCaptions
	? matched.map(([path]) => {
		const filename = path.split('/').pop()?.replace(/\.[^.]+$/, '') || '';
		return filename.replace(/[_-]/g, ' ');
	})
	: undefined;
---

{images.length > 0 && (
	<Gallery images={images} columns={columns} title={title} alts={alts} captions={captions} />
)}

{images.length === 0 && (
	<p><em>Gallery images not found for: {postSlug}/{galleryName}/</em></p>
)}
